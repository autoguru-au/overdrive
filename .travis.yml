language: node_js

cache:
  yarn: true
  directories:
    - node_modules

env:
  - TZ=Australia/Brisbane

branches:
  except:
    - /^v\d+\.\d+\.\d+$/

jobs:
  include:
    - stage: test
      script:
        - yarn test --no-cache --ci --coverage
        - yarn tsc --noEmit # we also wan't to check that a build can happen
      after_success:
        - curl -s https://codecov.io/bash | bash
        - |
          if [[ $TRAVIS_BRANCH == "master" && $TRAVIS_EVENT_TYPE == "push" ]]; then
            yarn run chromatic --auto-accept-changes;
          elif [[ $TRAVIS_EVENT_TYPE == "pull_request" && $TRAVIS_BRANCH != *"renovate/"* ]]; then
            yarn run chromatic; # This will fail on external PR's as Travis won't have the chromatic token
          else
            echo "Skipping chromatic, as it's more a regression tool...";
          fi

    - stage: deploy
      script: yarn storybook:build
      after_success: |
        if [ -n "$TRAVIS_PULL_REQUEST_SHA" ]; then
          npx surge -p ./storybook-static/ -d overdrive--${TRAVIS_PULL_REQUEST_SHA}.surge.sh && node ./scripts/githubStatusPost.js;
        elif [ $TRAVIS_BRANCH == "master" ]; then
          npx surge -p ./storybook-static/ -d overdrive.autoguru.io;
        fi
